<html>

    <head>
        
        <meta charset="utf-8"> 

        <script type="text/javascript" src="js/jquery-1.10.2.js">
        </script>

        <script type="text/javascript" src="js/jquery-ui-1.10.4.js">
        </script>
        
        <link href="css/calculo-notas.css"rel="stylesheet" />
		<link href="css/ui-lightness/jquery-ui-1.10.4.css" rel="stylesheet" />
        
        <script type="text/javascript">
		

            function aseguraNumeroEvaluaciones(numero){
                var evElement = $(".evaluacion").first();
                var parent = evElement.parent();
                for( var i = 0 ; i < numero-1 ; i++ ){
                    parent.append( evElement.clone() ); 
                }
            }
            
            function convertirExplicaciones(){
                var explicacionModulo = "La nota del módulo es la media de las notas de las evaluaciones, redondeada. "
                    "Si alguna evaluación puntua por debajo de 5, la nota máxima será un 4."

                var explicacionEvaluacion = "La nota de la evaluación se calcula a partir de las notas de los " +
                    "exámenes, trabajos y actitud. Es una suma poderada en la que los exámenes cuentan un 65%, " +
                    " los trabajos un 30% y la actitud un 5%";

                var explicacionExamenes = "Si se tiene más de un 3,5 en cada parcial, se calcula su media. " +
                            "La nota será la media de los parciales o la del final, la que sea mayor. " +
                            "Si se suspendiera la evaluación, en Junio habría una recuperación de la parte de exámenes de la nota. " +
                            "(Los trabajos podrían recuperarse volviendo a entregarlos con los fallos corregidos). ";

                var explicacionTrabajos = "En cada evaluación habrá una cantidad variable de trabajos (al menos uno). La nota de los trabajos será la " +
                        "media de las notas obtenidas. " +
                        "Para recuperar un trabajo, se deberá entregar de nuevo con los errores corregidos. Se avisará al profesor " +
                        "de qué trabajos se han reenviado el día del examen final de la evaluación. Un trabajo entregado tarde, o un " +
                        "trabajo reenviado para recuperar nota, puede obtener como máximo un 6 de puntuación.";

                var explicacionActitud = "La actitud se determina por la proactividad y ganas de trabajar que demuestra un alumno en clase." +
                            "La nota de actitud se calcula, en su mayor medida, por las veces que el alumno se presenta voluntario para " +
                            "resolver problemas en la pizarra, por las faltas de asistencia no justificadas y por la colaboración que "+
                            "demuestre con otros compañeros";


                function convertirEnExplicacion( selector, explicacion ){
                    var elems = $(selector);
                    elems.each( function(number,elem){
                        var toggle = $("<div/>", {
                            "class" : "toggle-explicacion"
                        });
                        toggle.html("?");
                        $(elem).append(toggle);

                        var textoExplicacion = $("<div/>",{
                            "class" : "texto-explicacion"
                        }).html(explicacion);
                        $(elem).append(textoExplicacion);

                        toggle.mouseenter(function(){
                            muestraOcultaTextoExplicacion(textoExplicacion);
                        });
                        
                        toggle.mouseleave(function(){
                            muestraOcultaTextoExplicacion(textoExplicacion);
                        });


                    });
                }
                
                function muestraOcultaTextoExplicacion(elem){
                    // TO DO: UTILIZAR JQUERYUI
                    $(elem).toggleClass("explicacion-visible");
                }

                convertirEnExplicacion(".explicacion-examenes",explicacionExamenes);
                convertirEnExplicacion(".explicacion-trabajos",explicacionTrabajos);
                convertirEnExplicacion(".explicacion-actitud",explicacionActitud);
                convertirEnExplicacion(".explicacion-evaluacion",explicacionEvaluacion);
                convertirEnExplicacion(".explicacion-modulo",explicacionModulo);
            }
            
    		function ajustaCampoNota( jqueryInput ){
    			var inputPattern = "((10)|(([0-9])(\\.[0-9]*)?)|(\\.[0-9]*))"

				jqueryInput.prop("pattern",inputPattern).
				            prop("min","0").
						    prop("max","10").
						    prop("step",".1");
			}
            
            function registraCalculadorNotaEvaluaciones(){

                function calculaNotaEvaluacion(evaluacion){
                    var elems = [".evaluacion-examenes",".evaluacion-trabajos",".evaluacion-actitud"];
                    var percentage = [.65,.3,.05];
                    var suma = 0;
                    for( i in elems ){
                        var id = elems[i];
                        var val = $(id,$(evaluacion)).val();
                        var v = parseFloat( val ) || 0;
                        console.log( id + ":" + val + ":" + v );
                        suma = suma + v*percentage[i];
                    }
                    $(".evaluacion-total",evaluacion ).val(suma).change();
                }

                var listener = function(event){
                    var evaluacion = $(event.currentTarget).parents(".evaluacion").first();
                    calculaNotaEvaluacion(evaluacion);
                };
                
                $(".evaluacion-examenes").change(listener);
                $(".evaluacion-trabajos").change(listener);
                $(".evaluacion-actitud").change(listener);
            }

            
            
            function actualizaBotonesAnadirTrabajos(){

                function calculaNotaTrabajos(trabajos){
                    
                    var notaEvaluacionTrabajos = $(".evaluacion-trabajos",trabajos);
                    var notasTrabajos = $(".nota-trabajo",trabajos); 
                    var cantidad = notasTrabajos.length;
                    console.log("cantidad:" + cantidad);
                    var suma = 0;
                    notasTrabajos.each( function(number,element){
                        var v = parseFloat(element.value);  
                        v = isNaN(v) ? 0 : v;
                        console.log( number + " " + v );
                        suma = suma + v;
                    });
                    var nota = suma/cantidad;
                    
                    console.log( "nota de trabajos:" + nota );
                    notaEvaluacionTrabajos.val(suma/cantidad).change();
                }

                
                $(".nuevo-trabajo").button().click( function(event){
                    
                    var t = $(event.target);
                    var contenedorTrabajos = t.closest(".calculo-trabajos");
                    
                    var trabajos = t.closest(".trabajos");
                    var notaTrabajos = $(".evaluacion-trabajos",trabajos);
                    
                    var div = $("<div/>", {
                        "class" : "trabajo"                                       
                    });
                    contenedorTrabajos.append( div );
                    
					var label = $("<label/>")
					label.html( "Trabajo" );
                    div.append( label );
				
					var campoNota = $("<input/>", {
						"type" : "number",
						"class" : "nota-trabajo"
						
					} );
				
					div.append( campoNota );
					
					ajustaCampoNota(campoNota);
                    
                    var quitarNota = $("<div>-</div>",{
                        "class" : "quitar-trabajo"
                    });
                    
                    div.append( quitarNota );
                    
                    quitarNota.button().click( function(event){
                        div.remove();
                        calculaNotaTrabajos(trabajos);
                    });
                    
                    campoNota.change( function(){
                        calculaNotaTrabajos(trabajos);
                    });
                
                    calculaNotaTrabajos(trabajos);
                    
                });
            }
            
            
            function registraCalculadorNotaExamenes(){
                
                function _registraCalculadorExamenes( number, elem ){
                    var context = $(elem);
                    function _calculadorExamenes(){
                        var total = $(".evaluacion-examenes",context);
                        var parciales = $(".evaluacion-examenes-parcial",context);
                        var recuperacion = $(".evaluacion-examenes-recuperacion",context);
                        var final = $(".evaluacion-examenes-final",context);
                        
                        var finalV = parseFloat( final.val() ) || 0;
                        var recuperacionV = parseFloat( recuperacion.val() ) || 0;
                        var p1 = parseFloat( parciales.get(0).value ) || 0;
                        var p2 = parseFloat( parciales.get(1).value ) || 0;
                        
                        console.log( "p1:" + p1 + "  p2:" + p2 + "  finalV:" + finalV + "  recuperacionV:" + recuperacionV );
                        var mediaP = (p1 + p2)/2;
                        var nota = mediaP;
                        var valeMediaP = mediaP >= 5.0;
                        if( valeMediaP ){
                            nota = Math.max(finalV,mediaP);
                        }
                        else if( finalV > mediaP ){
                            nota = finalV;
                        }
                        else{
                            nota = mediaP;
                        }

                        nota = Math.max(nota,recuperacionV);
                        console.log( "nota:" + nota );

                        total.val(nota).change();
                    }
                    
                    $(".evaluacion-examenes-parcial",context).change( _calculadorExamenes );
                    $(".evaluacion-examenes-recuperacion",context).change( _calculadorExamenes );
                    $(".evaluacion-examenes-final",context).change( _calculadorExamenes );
                }
                
                $(".examenes").each( _registraCalculadorExamenes );
            }
            
            
            
    
                    
            function ready(){

                function actualizaCalculados(){
                    $(".calculado").prop( "readonly", "readonly" )
                }

                function convertirEnLlaveExpandible(id){
                    var contenedorLlave = $("<div/>",{
                        "class": "contenedor-llave-expandible"
                    });

                    var llave = $("<div>+</div>").toggleClass( "llave-expandible" );

                    $(id).after(contenedorLlave);
                    $(id).toggleClass("oculto-por-llave");
                    contenedorLlave.append(llave);
                    contenedorLlave.append($(id));

                    llave.click( function(){
                        muestraOcultaLlave(llave,id);
                    });

                    function muestraOcultaLlave(llave,elem){
                        if( llave.html() == "+" ){
                            llave.html("-");
                        }
                        else{
                            llave.html("+");
                        }
                        // TO DO: UTILIZAR JQUERYUI
                        $(elem).toggleClass( "oculto-por-llave" );
                    }
                }
                
                aseguraNumeroEvaluaciones(3);
                
                convertirExplicaciones();
                
				ajustaCampoNota( $("input.nota") );
				
                registraCalculadorNotaExamenes();
                registraCalculadorNotaEvaluaciones();
                
                actualizaCalculados();
                actualizaBotonesAnadirTrabajos();
                
                $(".colapsable").each( function(number,elem){
                    convertirEnLlaveExpandible(elem);
                });
                
            }
            
	
            
            $(document).ready(ready);
            

        </script>
        
    </head>        

    <body>
        
        <div class="modulo">

            <div class="total">
                <label>Nota del módulo</label>
                <div class="explicacion-modulo explicacion">
                </div>
                <input class="nota calculado modulo-total" type="number"/>
            </div>


            <div class="calculo-modulo colapsable">
                <div class="evaluacion">

                    <div class="total">
                        <label>Nota de la evaluación 1</label>
                        <div class="explicacion-evaluacion explicacion">
                        </div>
                        <input class="nota calculado evaluacion-total" type="number"/>
                    </div>

                    <div class="calculo-total colapsable">

                        <div class="examenes">
                            <div class="total">
                                <label>Nota de exámenes</label>
                                <div class="explicacion-examenes explicacion"></div>
                                <input class="nota calculado evaluacion-examenes" type="number"/>
                            </div>


                            <div class="calculo-examenes colapsable">    

                                <div class="parcial">
                                    <label>Parcial 1</label>
                                    <input class="nota evaluacion-examenes-parcial" type="number"/>
                                </div>

                                <div class="parcial">
                                    <label>Parcial 2</label>
                                    <input class="nota evaluacion-examenes-parcial" type="number"/>
                                </div>

                                <div class="final">
                                    <label>Final</label>
                                    <input class="nota evaluacion-examenes-final" type="number" id="evaluacion1-final"/>
                                </div>

                                <div class="recuperacion">
                                    <label>Recuperación</label>
                                    <input class="nota evaluacion-examenes-recuperacion" type="number"/>
                                </div>
                                
                                <!--div class="nofloat">&nbsp;</div-->
                            </div>

                        </div>

                        <div class="trabajos">

                            <div class="total">
                                <label>Nota de trabajos</label>
                                <div class="explicacion-trabajos explicacion">
                                </div>    
                                <input class="nota calculado evaluacion-trabajos" type="number"/>
                            </div>

                            <div  class="calculo-trabajos colapsable">
                                <div class="nuevo-trabajo">+trabajo</div>
                            </div>

                        </div>

                        <div class="actitud">
                            <div class="total">
                                <label>Nota de actitud</label>
                                <div class="explicacion-actitud explicacion"></div>
                                <input class="nota evaluacion-actitud" type="number" />
                            </div>

                        </div>

                    </div>


                </div>

            </div>
        </div>
        
    </body>


</html>